From bbed752d18e9075b0796b9bb6749f36fc0285f2a Mon Sep 17 00:00:00 2001
From: Maxime Ripard <maxime@cerno.tech>
Date: Wed, 16 Mar 2022 09:53:03 +0100
Subject: [PATCH] Revert "bcm2835-unicam: Switch to new clock api"

This reverts commit 702228eb413876739f4fee8a9ec66b3e4e54efac.
---
 drivers/media/platform/bcm2835/bcm2835-unicam.c | 13 +++++++------
 1 file changed, 7 insertions(+), 6 deletions(-)

diff --git a/drivers/media/platform/bcm2835/bcm2835-unicam.c b/drivers/media/platform/bcm2835/bcm2835-unicam.c
index 1e0101bb3af9..401d2c4d734f 100644
--- a/drivers/media/platform/bcm2835/bcm2835-unicam.c
+++ b/drivers/media/platform/bcm2835/bcm2835-unicam.c
@@ -509,8 +509,6 @@ struct unicam_device {
 	struct clk *clock;
 	/* vpu clock handle */
 	struct clk *vpu_clock;
-	/* vpu clock request */
-	struct clk_request *vpu_req;
 	/* clock status for error handling */
 	bool clocks_enabled;
 	/* V4l2 device */
@@ -2548,8 +2546,8 @@ static int unicam_start_streaming(struct vb2_queue *vq, unsigned int count)
 	unicam_dbg(1, dev, "Running with %u data lanes\n",
 		   dev->active_data_lanes);
 
-	dev->vpu_req = clk_request_start(dev->vpu_clock, MIN_VPU_CLOCK_RATE);
-	if (!dev->vpu_req) {
+	ret = clk_set_min_rate(dev->vpu_clock, MIN_VPU_CLOCK_RATE);
+	if (ret) {
 		unicam_err(dev, "failed to set up VPU clock\n");
 		goto error_pipeline;
 	}
@@ -2605,7 +2603,8 @@ static int unicam_start_streaming(struct vb2_queue *vq, unsigned int count)
 	unicam_disable(dev);
 	clk_disable_unprepare(dev->clock);
 err_vpu_clock:
-	clk_request_done(dev->vpu_req);
+	if (clk_set_min_rate(dev->vpu_clock, 0))
+		unicam_err(dev, "failed to reset the VPU clock\n");
 	clk_disable_unprepare(dev->vpu_clock);
 error_pipeline:
 	media_pipeline_stop(&node->video_dev.entity);
@@ -2639,7 +2638,9 @@ static void unicam_stop_streaming(struct vb2_queue *vq)
 		media_pipeline_stop(&node->video_dev.entity);
 
 		if (dev->clocks_enabled) {
-			clk_request_done(dev->vpu_req);
+			if (clk_set_min_rate(dev->vpu_clock, 0))
+				unicam_err(dev, "failed to reset the min VPU clock\n");
+
 			clk_disable_unprepare(dev->vpu_clock);
 			clk_disable_unprepare(dev->clock);
 			dev->clocks_enabled = false;
-- 
2.32.0

