From 69742473e63108cd606210f57603ac35708950d4 Mon Sep 17 00:00:00 2001
From: Jonathan Bell <jonathan@raspberrypi.com>
Date: Fri, 16 Apr 2021 11:40:23 +0100
Subject: [PATCH 0620/2201] sound/usb: call usb_autopm_get_interface() for
 devices that should not be suspended

Webcams with microphones are composite devices, and autosuspend is set
at the device level. If uvcvideo is probed after snd-usb-audio, the effect
of the quirk applied by snd-usb-audio is undone by uvcvideo's global
application of autosuspend.

Incrementing the interface's PM refcount in such cases prevents runtime PM
from happening, thus the device is left active.

Signed-off-by: Jonathan Bell <jonathan@raspberrypi.com>
---
 sound/usb/quirks.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/sound/usb/quirks.c b/sound/usb/quirks.c
index 8388982cf6a0..dab95d009d5e 100644
--- a/sound/usb/quirks.c
+++ b/sound/usb/quirks.c
@@ -523,6 +523,11 @@ static int setup_disable_autosuspend(struct snd_usb_audio *chip,
 				       struct usb_driver *driver,
 				       const struct snd_usb_audio_quirk *quirk)
 {
+	/*
+	 * Grab the interface, because on a webcam uvcvideo may race
+	 * with snd-usb-audio during probe and re-enable autosuspend.
+	 */
+	usb_autopm_get_interface(iface);
 	usb_disable_autosuspend(interface_to_usbdev(iface));
 	return 1;	/* Continue with creating streams and mixer */
 }
-- 
2.17.1

