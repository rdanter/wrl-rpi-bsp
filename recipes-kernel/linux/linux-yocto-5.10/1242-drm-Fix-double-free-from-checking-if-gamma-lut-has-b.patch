From fb27937bd83e511bd2a89e5db3ab81f0f7c8209a Mon Sep 17 00:00:00 2001
From: Dave Stevenson <dave.stevenson@raspberrypi.com>
Date: Mon, 8 Nov 2021 13:55:15 +0000
Subject: [PATCH 1242/2201] drm: Fix double free from checking if gamma lut has
 been updated

The code falls through to "fail" under all conditions, so there is no
need for the drm_property_blob_put if the gamma lut hasn't been changed.
Fixes: 9cca26674a2b "drm: Check whether the gamma lut has changed before updating"

Signed-off-by: Dave Stevenson <dave.stevenson@raspberrypi.com>
---
 drivers/gpu/drm/drm_color_mgmt.c | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/drm_color_mgmt.c b/drivers/gpu/drm/drm_color_mgmt.c
index ec4a9a00a298..78933e2a5f44 100644
--- a/drivers/gpu/drm/drm_color_mgmt.c
+++ b/drivers/gpu/drm/drm_color_mgmt.c
@@ -316,8 +316,7 @@ static int drm_crtc_legacy_gamma_set(struct drm_crtc *crtc,
 	if (!crtc_state->gamma_lut || !crtc_state->gamma_lut->data ||
 	    memcmp(crtc_state->gamma_lut->data, blob_data, blob->length))
 		replaced |= drm_property_replace_blob(&crtc_state->gamma_lut, blob);
-	else
-		drm_property_blob_put(blob);
+
 	crtc_state->color_mgmt_changed |= replaced;
 
 	ret = drm_atomic_commit(state);
-- 
2.17.1

